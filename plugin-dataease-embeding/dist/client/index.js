/**
 * This file is part of the NocoBase (R) project.
 * Copyright (c) 2020-2024 NocoBase Co., Ltd.
 * Authors: NocoBase Team.
 *
 * This project is dual-licensed under AGPL-3.0 and NocoBase Commercial License.
 * For more information, please refer to: https://www.nocobase.com/agreement.
 */

!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@formily/shared"),require("@nocobase/client"),require("@formily/antd-v5"),require("react"),require("@formily/react"),require("@ant-design/icons"),require("antd"),require("react-i18next")):"function"==typeof define&&define.amd?define("@huaxia/plugin-dataease-embeding",["@formily/shared","@nocobase/client","@formily/antd-v5","react","@formily/react","@ant-design/icons","antd","react-i18next"],t):"object"==typeof exports?exports["@huaxia/plugin-dataease-embeding"]=t(require("@formily/shared"),require("@nocobase/client"),require("@formily/antd-v5"),require("react"),require("@formily/react"),require("@ant-design/icons"),require("antd"),require("react-i18next")):e["@huaxia/plugin-dataease-embeding"]=t(e["@formily/shared"],e["@nocobase/client"],e["@formily/antd-v5"],e.react,e["@formily/react"],e["@ant-design/icons"],e.antd,e["react-i18next"])}(self,function(e,t,r,n,o,a,l,i){return function(){"use strict";var c={753:function(e){var t=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable;e.exports=!function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},r=0;r<10;r++)t["_"+String.fromCharCode(r)]=r;var n=Object.getOwnPropertyNames(t).map(function(e){return t[e]});if("0123456789"!==n.join(""))return!1;var o={};if("abcdefghijklmnopqrst".split("").forEach(function(e){o[e]=e}),"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},o)).join(""))return!1;return!0}catch(e){return!1}}()?function(e,o){for(var a,l,i=function(e){if(null==e)throw TypeError("Object.assign cannot be called with null or undefined");return Object(e)}(e),c=1;c<arguments.length;c++){for(var s in a=Object(arguments[c]))r.call(a,s)&&(i[s]=a[s]);if(t){l=t(a);for(var u=0;u<l.length;u++)n.call(a,l[u])&&(i[l[u]]=a[l[u]])}}return i}:Object.assign},482:function(e){e.exports=a},632:function(e){e.exports=r},505:function(e){e.exports=o},875:function(t){t.exports=e},772:function(e){e.exports=t},721:function(e){e.exports=l},156:function(e){e.exports=n},238:function(e){e.exports=i}},s={};function u(e){var t=s[e];if(void 0!==t)return t.exports;var r=s[e]={exports:{}};return c[e](r,r.exports,u),r.exports}u.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return u.d(t,{a:t}),t},u.d=function(e,t){for(var r in t)u.o(t,r)&&!u.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},u.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},u.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var d={};return!function(){u.r(d),u.d(d,{PluginBlockDataeaseEmbedingClient:function(){return N},default:function(){return U}});var e=u(772),t=u(156),r=u.n(t),n=u(632),o=u(505),a=u(721),l=u(238),i=u(753),c=u.n(i),s=({url:e,allowFullScreen:t,position:n,display:o,height:a,width:l,overflow:i,styles:s,onLoad:u,onMouseOver:d,onMouseOut:p,scrolling:m,id:f,frameBorder:h,ariaHidden:b,sandbox:y,allow:g,className:v,title:w,ariaLabel:O,ariaLabelledby:x,name:E,target:P,loading:j,importance:S,referrerpolicy:k,allowpaymentrequest:I,src:D,key:T})=>{let M=c()({src:D||e,target:P||null,style:{position:n||null,display:o||"initial",overflow:i||null},scrolling:m||null,allowpaymentrequest:I||null,importance:S||null,sandbox:y&&[...y].join(" ")||null,loading:j||null,styles:s||null,name:E||null,className:v||null,allowFullScreen:"allowFullScreen",referrerpolicy:k||null,title:w||null,allow:g||null,id:f||null,"aria-labelledby":x||null,"aria-hidden":b||null,"aria-label":O||null,width:l||null,height:a||null,onLoad:u||null,onMouseOver:d||null,onMouseOut:p||null,key:T||"iframe"}),C=Object.create(null);for(let e of Object.keys(M))null!=M[e]&&(C[e]=M[e]);for(let e of Object.keys(C.style))null==C.style[e]&&delete C.style[e];if(C.styles)for(let e of Object.keys(C.styles))C.styles.hasOwnProperty(e)&&(C.style[e]=C.styles[e]),Object.keys(C.styles).pop()==e&&delete C.styles;if(t)if("allow"in C){let e=C.allow.replace("fullscreen","");C.allow=`fullscreen ${e.trim()}`.trim()}else C.allow="fullscreen";return h>=0&&!C.style.hasOwnProperty("border")&&(C.style.border=h),r().createElement("iframe",Object.assign({},C))},p=u(875);function m(e,t,r,n,o,a,l){try{var i=e[a](l),c=i.value}catch(e){r(e);return}i.done?t(c):Promise.resolve(c).then(n,o)}function f(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function l(e){m(a,n,o,l,i,"next",e)}function i(e){m(a,n,o,l,i,"throw",e)}l(void 0)})}}function h(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){var n;n=r[t],t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n})}return e}function b(e,t){var r,n,o,a,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(a){return function(i){var c=[a,i];if(r)throw TypeError("Generator is already executing.");for(;l;)try{if(r=1,n&&(o=2&c[0]?n.return:c[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,c[1])).done)return o;switch(n=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return l.label++,{value:c[1],done:!1};case 5:l.label++,n=c[1],c=[0];continue;case 7:c=l.ops.pop(),l.trys.pop();continue;default:if(!(o=(o=l.trys).length>0&&o[o.length-1])&&(6===c[0]||2===c[0])){l=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){l.label=c[1];break}if(6===c[0]&&l.label<o[1]){l.label=o[1],o=c;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(c);break}o[2]&&l.ops.pop(),l.trys.pop();continue}c=t.call(e,l)}catch(e){c=[6,e],n=0}finally{r=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function g(e,t,r,n,o,a,l){try{var i=e[a](l),c=i.value}catch(e){r(e);return}i.done?t(c):Promise.resolve(c).then(n,o)}function v(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r,n,o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var a=[],l=!0,i=!1;try{for(o=o.call(e);!(l=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);l=!0);}catch(e){i=!0,n=e}finally{try{l||null==o.return||o.return()}finally{if(i)throw n}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return y(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return y(e,t)}}(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e){return"string"==typeof e&&!isNaN(e)&&!isNaN(parseFloat(e))}var O=(0,o.observer)(function(n){var i=n.url,c=n.htmlId,u=n.mode,d=void 0===u?"url":u,p=n.height,m=(n.html,n.params),f=n.engine,h=n.account,b=function(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],!(t.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}(n,["url","htmlId","mode","height","html","params","engine","account"]),y=(0,o.useField)(),O=(0,l.useTranslation)().t,x=a.theme.useToken().token,E=(0,e.useBlockHeight)()||p,P=(0,e.useVariables)(),j=(0,e.useLocalVariables)(),S=(0,e.useCompile)(),k=(0,t.useRef)(null),I=(0,e.useRequest)({url:"iframeHtml:getHtml/".concat(c)},{refreshDeps:[c,y.data],ready:"html"===d&&!!c}),D=I.loading,T=I.data,M=(0,e.useParseURLAndParams)().parseURLAndParams,C=v((0,t.useState)(void 0),2),R=C[0],F=C[1],q=v((0,t.useState)(void 0),2),B=q[0],A=q[1],L=(0,e.useAPIClient)();return((0,t.useEffect)(function(){var t,r,n=(t=function(){var t,r,n,o,a,l,c;return function(e,t){var r,n,o,a,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(a){return function(i){var c=[a,i];if(r)throw TypeError("Generator is already executing.");for(;l;)try{if(r=1,n&&(o=2&c[0]?n.return:c[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,c[1])).done)return o;switch(n=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return l.label++,{value:c[1],done:!1};case 5:l.label++,n=c[1],c=[0];continue;case 7:c=l.ops.pop(),l.trys.pop();continue;default:if(!(o=(o=l.trys).length>0&&o[o.length-1])&&(6===c[0]||2===c[0])){l=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){l.label=c[1];break}if(6===c[0]&&l.label<o[1]){l.label=o[1],o=c;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(c);break}o[2]&&l.ops.pop(),l.trys.pop();continue}c=t.call(e,l)}catch(e){c=[6,e],n=0}finally{r=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(this,function(s){switch(s.label){case 0:return s.trys.push([0,6,,7]),console.log("Fetching token with account:",h),[4,L.resource("dataeaseEmbeding").generate({account:h})];case 1:if(console.log("API Response:",(o=s.sent()).data),console.log("fetchedToken",a=(null==(t=o.data)?void 0:t.token)||(null==(n=o.data)||null==(r=n.data)?void 0:r.token)),A(a),!a)return console.error("Failed to get embeddedToken."),[2];if("html"!==d)return[3,3];return[4,(0,e.getRenderContent)(f,T,S(P),S(j),function(e){return e})];case 2:if(void 0===(c=s.sent()))return console.warn("HTML content is undefined."),[2];return l="data:text/html;charset=utf-8,"+encodeURIComponent(c),[3,5];case 3:return[4,M(i,m||[])];case 4:if(console.log("Base targetSrc:",l=s.sent()),!l)return console.warn("URL mode requires a valid URL."),[2];s.label=5;case 5:return F(l),[3,7];case 6:return console.error("Error generating iframe source or fetching token:",s.sent()),A(void 0),[3,7];case 7:return[2]}})},r=function(){var e=this,r=arguments;return new Promise(function(n,o){var a=t.apply(e,r);function l(e){g(a,n,o,l,i,"next",e)}function i(e){g(a,n,o,l,i,"throw",e)}l(void 0)})},function(){return r.apply(this,arguments)});("html"===d?c&&void 0!==T:i)?void 0===R&&n():"url"!==d||i||console.warn("URL mode requires a URL.")},[T,d,i,P,j,m,h,L,c,f,S,M]),(0,t.useEffect)(function(){var e=function(e){if((null==(o=e.data)?void 0:o.msgOrigin)==="de-fit2cloud"){console.log("Received message from iframe (de-fit2cloud): ",e.data);var t=k.current,r=t&&t.contentWindow&&"string"==typeof t.src&&""!==t.src,n=!!B;if(console.log("Check conditions for postMessage:"),console.log("  isIframeReady:",r),console.log("    iframeRef.current available:",!!t),console.log("    contentWindow available:",!!(t&&t.contentWindow)),console.log("    iframe.src available and not empty:","string"==typeof(null==t?void 0:t.src)&&(null==t?void 0:t.src)!==""),console.log("  isTokenReady:",n),console.log("    embeddedTokenState available:",n),r&&n){console.log("All conditions met. Preparing postMessage...");var o,a,l={busiFlag:"dashboard",resourceId:"123",type:"Dashboard",embeddedToken:B,"de-embedded":!0};if(console.log("Sending postMessage params:",l),t.src.startsWith("data:"))a="*",console.log("iframe src is data URL, using target origin: *");else try{a=new URL(t.src).origin,console.log("iframe src is standard URL, using target origin:",a)}catch(e){console.error("Error determining origin from iframe.src:",e),console.warn("Failed to determine specific origin, falling back to *: ",a="*")}console.log("Using target origin:",a);try{t.contentWindow.postMessage(l,a),console.log("PostMessage sent based on iframe message.")}catch(e){console.error("Error sending postMessage based on iframe message:",e)}}else console.warn("PostMessage skipped on iframe message: conditions not met.")}};return window.addEventListener("message",e),function(){window.removeEventListener("message",e)}},[B,k.current]),("url"!==d||i)&&("html"!==d||c))?void 0===R||!B||"html"===d&&D?r().createElement("div",{style:{height:w(E)?"".concat(E,"px"):E||"60vh",marginBottom:x.padding,border:0,display:"flex",justifyContent:"center",alignItems:"center"}},r().createElement(a.Spin,null)):R?r().createElement(s,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){var n;n=r[t],t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n})}return e}({url:R,ref:k,width:"100%",display:"block",position:"relative",styles:{height:w(E)?"".concat(E,"px"):E||"60vh",marginBottom:"24px",border:0}},b)):r().createElement(a.Card,{style:{marginBottom:x.padding,height:w(E)?"".concat(E,"px"):E}},O("Failed to load iframe.")):r().createElement(a.Card,{style:{marginBottom:x.padding,height:w(E)?"".concat(E,"px"):E}},O("Please fill in the iframe URL"))},{displayName:"DataeaseEmbeding"});O.Designer=function(){var t,n,a=(0,o.useField)(),i=(0,o.useFieldSchema)(),c=(0,l.useTranslation)().t,s=(0,e.useDesignable)().dn,u=(0,e.useAPIClient)(),d=i["x-component-props"]||{},m=d.mode,y=d.url,g=d.htmlId,v=d.height,w=void 0===v?"60vh":v;d.engine;var O=(t=f(function(e){var t,r,n,o,a,l,i,c;return b(this,function(s){switch(s.label){case 0:var d,p;if(t={values:{html:e}},!g)return[3,2];return[4,null==(r=(n=u.resource("iframeHtml")).update)?void 0:r.call(n,(d=h({},t),p=p={filterByTk:g},Object.getOwnPropertyDescriptors?Object.defineProperties(d,Object.getOwnPropertyDescriptors(p)):(function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r})(Object(p)).forEach(function(e){Object.defineProperty(d,e,Object.getOwnPropertyDescriptor(p,e))}),d))];case 1:return[2,(null==(a=s.sent().data)||null==(o=a.data)?void 0:o[0])||{id:g}];case 2:return[4,null==(l=(i=u.resource("iframeHtml")).create)?void 0:l.call(i,t)];case 3:return[2,null==(c=s.sent().data)?void 0:c.data];case 4:return[2]}})}),function(e){return t.apply(this,arguments)}),x=(n=f(function(e){var t,r,n,o,l,c,u;return b(this,function(d){switch(d.label){case 0:if(t=e.mode,r=e.url,n=e.html,o=e.height,l=e.engine,(c=i["x-component-props"]||{}).mode=t,c.height=o,c.url=r,c.engine=l||"string","html"!==t)return[3,2];return[4,O(n)];case 1:u=d.sent(),c.htmlId=u.id,d.label=2;case 2:return i["x-component-props"]=c,a.componentProps=h({},c),a.data={v:(0,p.uid)()},s.emit("patch",{schema:{"x-uid":i["x-uid"],"x-component-props":c}}),[2]}})}),function(e){return n.apply(this,arguments)}),E=(0,e.useFormBlockContext)().form,P=(0,e.useRecord)(),j=(0,e.useVariableOptions)({collectionField:{uiSchema:i},form:E,record:P,uiSchema:i,noDisabled:!0});return r().createElement(e.GeneralSchemaDesigner,null,r().createElement(e.SchemaSettingsModalItem,{title:c("Edit Dataease Embeding"),asyncGetInitialValues:f(function(){var e,t,r,n,o;return b(this,function(a){switch(a.label){case 0:if(e={mode:m,url:y,height:w},!g)return[3,2];return[4,null==(t=(r=u.resource("iframeHtml")).get)?void 0:t.call(r,{filterByTk:g})];case 1:o=a.sent().data,e.html=(null==o||null==(n=o.data)?void 0:n.html)||"",a.label=2;case 2:return[2,e]}})}),schema:{type:"object",title:c("Edit Dataease Embeding"),properties:{mode:{title:'{{t("Mode")}}',"x-component":"Radio.Group","x-decorator":"FormItem",required:!0,default:"url",enum:[{value:"url",label:c("URL")},{value:"html",label:c("HTML")}]},url:{title:c("URL"),type:"string","x-decorator":"FormItem","x-component":"Variable.TextArea","x-component-props":{scope:j},required:!0,"x-reactions":{dependencies:["mode"],fulfill:{state:{hidden:'{{$deps[0] === "html"}}'}}}},engine:{title:'{{t("Template engine")}}',"x-component":"Radio.Group","x-decorator":"FormItem",enum:[{value:"string",label:c("String template")},{value:"handlebars",label:c("Handlebars")}],"x-reactions":{dependencies:["mode"],fulfill:{state:{hidden:'{{$deps[0] === "url"}}'}}}},html:{title:c("html"),type:"string","x-decorator":"FormItem","x-component":"Variable.RawTextArea","x-component-props":{scope:j,style:{minHeight:"200px"}},required:!0,"x-reactions":{dependencies:["mode"],fulfill:{state:{hidden:'{{$deps[0] === "url"}}'}}}},height:{title:c("Height"),type:"string","x-decorator":"FormItem","x-component":"Input",required:!0}}},onSubmit:x}),r().createElement(e.SchemaSettingsDivider,null),r().createElement(e.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}}))};var x=u(482),E=function(){var t,n,o=(0,e.useSchemaInitializer)().insert,a=(0,e.useSchemaInitializerItem)();return r().createElement(e.SchemaInitializerItem,(t=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){var n;n=r[t],t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n})}return e}({},a),n=n={icon:r().createElement(x.PicRightOutlined,null),onClick:function(){o({type:"void","x-settings":"blockSettings:dataease-embeding","x-decorator":"BlockItem","x-decorator-props":{name:"dataease-embeding"},"x-component":"DataeaseEmbeding","x-component-props":{}})}},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):(function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r})(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}),t))},P=function(t){return r().createElement(e.SchemaComponentOptions,{components:{DataeaseEmbeding:O,DataeaseEmbedingBlockInitializer:E,ArrayItems:n.ArrayItems}},t.children)};function j(e,t,r,n,o,a,l){try{var i=e[a](l),c=i.value}catch(e){r(e);return}i.done?t(c):Promise.resolve(c).then(n,o)}function S(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function l(e){j(a,n,o,l,i,"next",e)}function i(e){j(a,n,o,l,i,"throw",e)}l(void 0)})}}function k(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){var n;n=r[t],t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n})}return e}function I(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):(function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r.push.apply(r,n)}return r})(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function D(e,t){var r,n,o,a,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(a){return function(i){var c=[a,i];if(r)throw TypeError("Generator is already executing.");for(;l;)try{if(r=1,n&&(o=2&c[0]?n.return:c[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,c[1])).done)return o;switch(n=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return l.label++,{value:c[1],done:!1};case 5:l.label++,n=c[1],c=[0];continue;case 7:c=l.ops.pop(),l.trys.pop();continue;default:if(!(o=(o=l.trys).length>0&&o[o.length-1])&&(6===c[0]||2===c[0])){l=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){l.label=c[1];break}if(6===c[0]&&l.label<o[1]){l.label=o[1],o=c;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(c);break}o[2]&&l.ops.pop(),l.trys.pop();continue}c=t.call(e,l)}catch(e){c=[6,e],n=0}finally{r=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var T=function(e){var t=e.type,n=(0,l.useTranslation)(),o=n.t,i=n.i18n,c={autoplay:o("Controls whether the current document is allowed to autoplay media requested through the HTMLMediaElement interface. When this policy is disabled and there were no user gestures, the Promise returned by HTMLMediaElement.play() will reject with a NotAllowedError DOMException. The autoplay attribute on <audio> and <video> elements will be ignored."),camera:o("Controls whether the current document is allowed to use video input devices. When this policy is disabled, the Promise returned by getUserMedia() will reject with a NotAllowedError DOMException."),"document-domain":o("Controls whether the current document is allowed to set document.domain. When this policy is disabled, attempting to set document.domain will fail and cause a SecurityError DOMException to be thrown."),"encrypted-media":o("Controls whether the current document is allowed to use the Encrypted Media Extensions API (EME). When this policy is disabled, the Promise returned by Navigator.requestMediaKeySystemAccess() will reject with a SecurityError DOMException."),fullscreen:o("Controls whether the current document is allowed to use Element.requestFullscreen(). When this policy is disabled, the returned Promise rejects with a TypeError."),geolocation:o("Controls whether the current document is allowed to use the Geolocation Interface. When this policy is disabled, calls to getCurrentPosition() and watchPosition() will cause those functions callbacks to be invoked with a GeolocationPositionError code of PERMISSION_DENIED."),microphone:o("Controls whether the current document is allowed to use audio input devices. When this policy is disabled, the Promise returned by MediaDevices.getUserMedia() will reject with a NotAllowedError DOMException."),midi:o("Controls whether the current document is allowed to use the Web MIDI API. When this policy is disabled, the Promise returned by Navigator.requestMIDIAccess() will reject with a SecurityError DOMException."),payment:o("Controls whether the current document is allowed to use the Payment Request API. When this policy is enabled, the PaymentRequest() constructor will throw a SecurityError DOMException.")}[t];return r().createElement("span",null,t," ",r().createElement(a.Tooltip,{zIndex:9999,title:r().createElement("span",null,c," ",r().createElement("a",{href:"https://developer.mozilla.org/".concat("zh-CN"===i.language?"zh-CN":"en-US","/docs/Web/HTTP/Reference/Headers/Permissions-Policy/").concat(t),target:"_blank",rel:"noreferrer"},r().createElement(x.LinkOutlined,null)))},r().createElement(x.QuestionCircleOutlined,null)))},M=function(){var e=(0,l.useTranslation)(),t=e.t,n="zh-CN"===e.i18n.language?"https://developer.mozilla.org/zh-CN/docs/Web/HTML/Reference/Elements/iframe#allow":"https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/iframe#allow";return r().createElement("span",null,t("Specifies a Permissions Policy for the <iframe>. The policy defines what features are available to the <iframe> (for example, access to the microphone, camera, battery, web-share, etc.) based on the origin of the request.")," ",r().createElement("a",{href:n,target:"_blank",rel:"noreferrer"},r().createElement(x.LinkOutlined,null)))},C={items:[{name:"EditDataeaseEmbeding",type:"modal",useComponentProps:function(){var t,n,i,c=(0,o.useField)(),s=(0,o.useFieldSchema)(),u=(0,l.useTranslation)(),d=u.t,m=u.i18n,f=(0,e.useDesignable)().dn,h=(0,e.useAPIClient)(),b=s["x-component-props"]||{},y=b.mode,g=b.url,v=b.chartType,w=b.templateId,O=b.businessFlag,x=b.account,E=b.params,P=b.htmlId,j=b.height,C=void 0===j?"60vh":j,R=b.engine,F=b.allow,q=(t=S(function(e){var t,r,n,o,a,l,i,c;return D(this,function(s){switch(s.label){case 0:if(t={values:{html:e}},!P)return[3,2];return[4,null==(r=(n=h.resource("iframeHtml")).update)?void 0:r.call(n,I(k({},t),{filterByTk:P}))];case 1:return[2,(null==(a=s.sent().data)||null==(o=a.data)?void 0:o[0])||{id:P}];case 2:return[4,null==(l=(i=h.resource("iframeHtml")).create)?void 0:l.call(i,t)];case 3:return[2,null==(c=s.sent().data)?void 0:c.data];case 4:return[2]}})}),function(e){return t.apply(this,arguments)}),B=(0,e.useURLAndHTMLSchema)(),A=B.urlSchema,L=B.paramsSchema,z=(n=S(function(e){var t,r,n,o,a,l,i,u,d,m,h,b,y;return D(this,function(g){switch(g.label){case 0:if(t=e.mode,r=e.url,n=e.chartType,o=e.templateId,a=e.businessFlag,l=e.account,i=e.html,u=e.height,d=e.params,m=e.engine,h=e.allow,(b=s["x-component-props"]||{}).mode=t,b.height=u,b.engine=m||"string",b.params=d,b.url=r,b.allow=h,b.chartType=n,b.templateId=o,b.businessFlag=a,b.account=l,"html"!==t)return[3,2];return[4,q(i)];case 1:y=g.sent(),b.htmlId=y.id,g.label=2;case 2:return s["x-component-props"]=b,c.componentProps=k({},b),c.data={v:(0,p.uid)()},f.emit("patch",{schema:{"x-uid":s["x-uid"],"x-component-props":b}}),[2]}})}),function(e){return n.apply(this,arguments)}),H=r().createElement(r().Fragment,null,r().createElement("span",{style:{marginLeft:".25em"},className:"ant-formily-item-extra"},d("Syntax references"),":")," ",r().createElement("a",{href:"https://".concat("zh-CN"===m.language?"docs-cn":"docs",".nocobase.com/handbook/template-handlebars"),target:"_blank",rel:"noreferrer"},"Handlebars.js"));return{title:d("Edit dataease embeding"),asyncGetInitialValues:S(function(){var e,t,r,n,o;return D(this,function(a){switch(a.label){case 0:if(e={mode:y,url:g,chartType:v,templateId:w,businessFlag:O,account:x,height:C,engine:R,params:E,allow:F},!P)return[3,2];return[4,null==(t=(r=h.resource("iframeHtml")).get)?void 0:t.call(r,{filterByTk:P})];case 1:o=a.sent().data,e.html=(null==o||null==(n=o.data)?void 0:n.html)||"",a.label=2;case 2:return[2,e]}})}),schema:{type:"object",title:d("Edit dataease embeding"),properties:{mode:{title:'{{t("Mode")}}',"x-component":"Radio.Group","x-decorator":"FormItem",required:!0,default:"url",enum:[{value:"url",label:d("URL")},{value:"html",label:d("HTML")}]},url:I(k({},A),{required:!0}),chartType:{title:'{{t("Chart Type")}}',"x-component":"Radio.Group","x-decorator":"FormItem",required:!0,default:"chart","x-visible":'{{$values.mode === "url"}}',enum:[{value:"dashboard",label:d("Dashboard")},{value:"chart",label:d("Chart")},{value:"screen",label:d("Big Screen")}]},templateId:{title:'{{t("Template ID")}}',type:"string","x-component":"Input","x-decorator":"FormItem","x-visible":'{{$values.mode === "url"}}',required:!0,"x-component-props":{placeholder:'{{t("Please enter template ID")}}'}},businessFlag:{title:'{{t("Business Flag")}}',type:"string","x-component":"Input","x-decorator":"FormItem","x-visible":'{{$values.mode === "url"}}',required:!0,"x-component-props":{placeholder:'{{t("Please enter business flag")}}'}},account:{title:'{{t("Account")}}',type:"string","x-component":"Input","x-decorator":"FormItem","x-visible":'{{$values.mode === "url"}}',required:!0},allow:{title:"Allow",type:"string","x-decorator":"FormItem","x-component":function(e){return r().createElement(a.Select,I(k({},e),{allowClear:!0,options:[{value:"autoplay",label:r().createElement(T,{type:"autoplay"})},{value:"camera",label:r().createElement(T,{type:"camera"})},{value:"document-domain",label:r().createElement(T,{type:"document-domain"})},{value:"encrypted-media",label:r().createElement(T,{type:"encrypted-media"})},{value:"fullscreen",label:r().createElement(T,{type:"fullscreen"})},{value:"geolocation",label:r().createElement(T,{type:"geolocation"})},{value:"microphone",label:r().createElement(T,{type:"microphone"})},{value:"midi",label:r().createElement(T,{type:"midi"})},{value:"payment",label:r().createElement(T,{type:"payment"})}]}))},description:r().createElement(M,null)},params:L,engine:{title:'{{t("Template engine")}}',"x-component":"Radio.Group","x-decorator":"FormItem",default:"string",enum:[{value:"string",label:d("String template")},{value:"handlebars",label:d("Handlebars")}],"x-reactions":{dependencies:["mode"],fulfill:{state:{hidden:'{{$deps[0] === "url"}}'}}}},html:{title:d("html"),type:"string","x-decorator":"FormItem","x-component":(i=e.Variable.RawTextArea,function(t){var n=(0,o.useFieldSchema)(),a=(0,e.useFormBlockContext)().form,l=(0,e.useRecord)(),c=(0,e.useVariableOptions)({collectionField:{uiSchema:n},form:a,record:l,uiSchema:n,noDisabled:!0});return r().createElement(i,I(k({},t),{scope:c}))}),"x-component-props":{rows:10},required:!0,description:H,"x-reactions":[{dependencies:["mode"],fulfill:{state:{hidden:'{{$deps[0] === "url"}}'}}},function(e){"handlebars"===e.form.values.engine?e.description=H:e.description=null}]}}},onSubmit:z,noRecord:!0,width:600}}},{name:"setTheBlockHeight",Component:e.SchemaSettingsBlockHeightItem},{name:"divider",type:"divider"},{name:"delete",type:"remove",useComponentProps:function(){return{removeParentsIfNoChildren:!0,breakRemoveOn:{"x-component":"Grid"}}}}]},R=new e.SchemaSettings(k({name:"dataeaseEmbedingBlockSchemaSettings"},C)),F=new e.SchemaSettings(k({name:"blockSettings:dataease-embeding"},C));function q(e,t,r,n,o,a,l){try{var i=e[a](l),c=i.value}catch(e){r(e);return}i.done?t(c):Promise.resolve(c).then(n,o)}function B(e,t,r){return(B=H()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&L(o,r.prototype),o}).apply(null,arguments)}function A(e){return(A=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function L(e,t){return(L=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function z(e){var t="function"==typeof Map?new Map:void 0;return(z=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return B(e,arguments,A(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),L(r,e)})(e)}function H(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(H=function(){return!!e})()}var N=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return e=r,t=arguments,e=A(e),function(e,t){var r;if(t&&("object"==((r=t)&&"undefined"!=typeof Symbol&&r.constructor===Symbol?"symbol":typeof r)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,H()?Reflect.construct(e,t||[],A(this).constructor):e.apply(this,t))}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&L(r,e),t=[{key:"load",value:function(){var e,t=this;return(e=function(){var e,r,n,o;return function(e,t){var r,n,o,a,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(a){return function(i){var c=[a,i];if(r)throw TypeError("Generator is already executing.");for(;l;)try{if(r=1,n&&(o=2&c[0]?n.return:c[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,c[1])).done)return o;switch(n=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return l.label++,{value:c[1],done:!1};case 5:l.label++,n=c[1],c=[0];continue;case 7:c=l.ops.pop(),l.trys.pop();continue;default:if(!(o=(o=l.trys).length>0&&o[o.length-1])&&(6===c[0]||2===c[0])){l=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){l.label=c[1];break}if(6===c[0]&&l.label<o[1]){l.label=o[1],o=c;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(c);break}o[2]&&l.ops.pop(),l.trys.pop();continue}c=t.call(e,l)}catch(e){c=[6,e],n=0}finally{r=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(this,function(a){return t.app.schemaSettingsManager.add(R),t.app.schemaSettingsManager.add(F),t.app.use(P),null==(e=t.app.schemaInitializerManager.get("page:addBlock"))||e.add("otherBlocks.dataeaseEmbeding",{title:'{{t("Dataease Embeding")}}',Component:"DataeaseEmbedingBlockInitializer"}),null==(r=t.app.schemaInitializerManager.get("popup:addNew:addBlock"))||r.add("otherBlocks.dataeaseEmbeding",{title:'{{t("Dataease Embeding")}}',Component:"DataeaseEmbedingBlockInitializer"}),null==(n=t.app.schemaInitializerManager.get("popup:common:addBlock"))||n.add("otherBlocks.dataeaseEmbeding",{title:'{{t("Dataease Embeding")}}',Component:"DataeaseEmbedingBlockInitializer"}),null==(o=t.app.schemaInitializerManager.get("RecordFormBlockInitializers"))||o.add("otherBlocks.dataeaseEmbeding",{title:'{{t("Dataease Embeding")}}',Component:"DataeaseEmbedingBlockInitializer"}),t.app.schemaInitializerManager.addItem("mobilePage:addBlock","otherBlocks.dataeaseEmbeding",{title:'{{t("Dataease Embeding")}}',Component:"DataeaseEmbedingBlockInitializer"}),t.app.schemaInitializerManager.addItem("mobile:addBlock","otherBlocks.dataeaseEmbeding",{title:'{{t("Dataease Embeding")}}',Component:"DataeaseEmbedingBlockInitializer"}),[2]})},function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function l(e){q(a,n,o,l,i,"next",e)}function i(e){q(a,n,o,l,i,"throw",e)}l(void 0)})})()}}],function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(r.prototype,t),r}(z(e.Plugin)),U=N}(),d}()});